# 開発者ガイド

## ディレクトリ構成と責務
| パス | 役割 |
| ---- | ---- |
| `app/app.py` | エントリーポイント。Qt アプリケーションの初期化とメインウィンドウ生成。 |
| `app/ui/` | Qt Designer 生成コードと UI ウィジェット。ビュー層の責務を担います。 |
| `app/playback/` | タイムラインデータモデルと再生ループ、補間ロジック。 |
| `app/telemetry/` | テレメトリ生成・整形 (`assembler` など) と送信制御。 |
| `app/net/` | UDP 送信などネットワーク周りの実装。 |
| `app/io/` | CSV エクスポートなど入出力ユーティリティ。 |
| `app/actions/` | UI コマンドとショートカットのバインド。 |
| `tools/` | UDP 受信などの補助スクリプト。 |
| `documents/` | このプロジェクトのドキュメント群。 |

より詳細なアーキテクチャ図は [architecture.md](architecture.md) を参照してください。

## データフロー概要
```
PlaybackController → TelemetryBridge → PayloadAssembler → UdpSender
```
1. **PlaybackController**: 再生状態・現在時刻を管理。キーフレームデータを補間して現在値を取得します。
2. **TelemetryBridge**: 再生イベントを受け取り、再生中に限ってテレメトリ送信スレッドを起動/停止します。
3. **PayloadAssembler**: 現在値を JSON 構造に整形。`session_id` や `frame_index` を付与します。
4. **UdpSender**: 指定レートで送信を実施。高精度タイマーを用いてドリフトを抑制します。

## コーディング規約とツール
- **スタイル**: `black` (88 列) と `isort` に準拠することを推奨します。
- **型ヒント**: 主要な関数・クラスには `typing` ベースの型注釈を追加します。
- **テスト**: `pytest` を使用（`app/tests/` 配下）。必要に応じてモックで GUI 依存を切り離します。
- **静的解析**: `mypy` を導入済みであれば `mypy app` の実行を推奨します。
- 変更前に `requirements.txt` を更新する場合は、互換性検証を行い README とドキュメントを合わせて修正してください。

## ブランチ運用とコミット
- メインブランチは常にリリース可能な状態を維持してください。
- 機能追加は `feature/<summary>`、バグ修正は `fix/<issue>` のようなトピックブランチを作成します。
- コミットメッセージは「領域: 要約」の形式（例: `telemetry: clamp rate upper bound`）で短く具体的に書きます。
- Pull Request では、概要とテスト結果（実行コマンド）を記載してください。

## ローカル検証手順
1. 単体テスト
   ```bash
   pytest
   ```
2. GUI 実行確認
   ```bash
   python -m app.app
   ```
3. UDP 受信テスト
   ```bash
   python tools/udp_recv.py
   ```
   - 別ウィンドウでアプリを再生し、メッセージが流れることを確認します。
4. ログの確認
   - 標準出力またはアプリ内コンソールに INFO ログが出力されます。必要に応じて `logging` レベルを調整してください。

## 将来拡張の方向性
- テレメトリメッセージの圧縮や TLS 対応などのネットワーク強化
- キーフレーム編集の一括操作（複数選択コピー、ペースト）
- スクリプト API の公開による自動化支援
- 設定プロファイルのエクスポート/インポート機能
