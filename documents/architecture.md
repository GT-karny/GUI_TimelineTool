# アーキテクチャ概要

## 目的とスコープ
GUI Timeline Tool は、複数トラックのキーフレームを編集し、リアルタイムに再生・外部出力することを目的としたデスクトップアプリケーションです。本書はアプリ全体の構造と主要コンポーネントの関係を概観します。ハードリアルタイム性や 3D 描画機能はスコープ外です。

## コンポーネント
| コンポーネント | 主な責務 |
| -------------- | -------- |
| UI (app/ui) | Qt Widgets を用いた表示・操作。ツールバー、タイムラインエディタ、設定ダイアログを提供。 |
| Playback (app/playback) | タイムラインデータモデル、補間ロジック、再生状態管理。UI からの操作を受け取り現在値を算出。 |
| Telemetry (app/telemetry) | 再生中の値を JSON に整形し、送信キューへ渡す。セッション管理を含む。 |
| Network (app/net) | UDP 送信スレッドと高精度スケジューラ。負荷分散とレート制御を担当。 |
| IO (app/io) | CSV エクスポートなど外部ファイル連携。 |
| Settings (QSettings) | ユーザー設定の保存・復元を司る。 |

## 時間管理とスレッドモデル
- UI スレッド: Qt のメインスレッド。ユーザー操作、タイムライン描画、再生開始/停止のトリガーを担当します。
- 再生ループ: UI スレッド内でタイマー駆動し、現在の再生位置を更新。補間済みの値を Telemetry に引き渡します。
- 送信スレッド: `app/net/udp_sender.py`（想定）などで独立スレッドを生成。`time.perf_counter_ns()` に基づき、指定周期で最新ペイロードを送出します。オーバーラン時はドリフト補正を行い、UI スレッドをブロックしません。

## 設定と永続化
- Qt の QSettings を使用し、`/telemetry/*` や `/playback/loop_enabled` などのキーを保存します。
- 設定値は起動時に読み込まれ、UI の既定値に反映されます。変更はリアルタイムにテレメトリモジュールへ伝達されます。
- 保存先は OS 既定のアプリケーション設定ディレクトリ（例: Windows レジストリ、macOS の `~/Library/Preferences`、Linux の `~/.config`）。

## 補足
- Telemetry モジュールは再生状態に同期しており、停止時は送信スレッドを停止させてネットワーク負荷を抑えます。
- CSV エクスポートとテレメトリ送信は独立した経路を持つため、同時に実行しても互いをブロックしません。
- 今後、新たな出力プロトコルを追加する場合は Telemetry → Network の境界を利用し、`PayloadAssembler` と送信実装を差し替えることで対応しやすくなっています。
