# UDP テレメトリ運用ガイド

## Overview
- **送信条件**: タイムラインが再生状態のときのみ送信します。停止・一時停止時は送信しません。
- **プロトコル**: UDP / JSON。1 メッセージ = 1 フレームの値スナップショット。
- **デフォルト送信先**: `127.0.0.1:9000`
- **レート指定**: 設定パネルの「Rate (Hz)」で 1〜240 Hz の整数を指定。UI 上の表示は内部ガバナーへ即時反映されます。

## JSON フォーマット (v0.6.0)
| フィールド | 型 | 説明 |
| ---------- | --- | ---- |
| `version` | string | プロトコルバージョン。現在は常に `"0.6.0"` |
| `session_id` | string | 送信セッション識別子。未設定時は起動毎に自動生成 |
| `timestamp_ms` | integer | タイムライン内の現在位置（ミリ秒） |
| `frame_index` | integer | 再生開始からのフレーム数 (0 起点) |
| `tracks` | array<object> | 各トラックの値。要素は `{"name": str, "value": number}` |

### サンプルペイロード
```json
{
  "version": "0.6.0",
  "session_id": "demo-session",
  "timestamp_ms": 1320,
  "frame_index": 33,
  "tracks": [
    {"name": "camera.fov", "value": 65.0},
    {"name": "rig.lift", "value": 1.42}
  ]
}
```

## 送信タイミングとレート制御
- 送信スレッドは UI スレッドから独立しており、`time.perf_counter_ns()` ベースの高精度ガバナーでスケジューリングします。
- 1 フレームごとに締切時刻を固定ステップで進め、遅延が発生した場合は次回送信でドリフトを補正します。
- 再生中に複数フレームがスキップされるケースでも、常に最新フレームのみ送信し、過去フレームのバースト送信は行いません。

## 設定方法
| UI 上の項目 | QSettings キー | 型 | 備考 |
| ------------ | --------------- | --- | ---- |
| Enable UDP telemetry | `/telemetry/enabled` | bool | 送信を有効化するとスレッドが起動します |
| Target IP address | `/telemetry/ip` | str | 例: `127.0.0.1` |
| Target port | `/telemetry/port` | int | 例: `9000` |
| Rate (Hz) | `/telemetry/rate_hz` | int | 1〜240 の整数 |
| Session ID | `/telemetry/session_id` | str | 空欄時は自動生成 |
| Loop playback | `/playback/loop_enabled` | bool | ループ状態はテレメトリにも反映されます |

- 設定値はアプリ終了後も保持され、次回起動時に復元されます。
- QSettings の保存先は OS 依存ですが、Qt の標準パスを使用します（レジストリ/`~/.config` 等）。

## 動作確認手順
1. 別ターミナルで受信スクリプトを起動します。
   ```bash
   python tools/udp_recv.py
   ```
2. アプリケーションでテレメトリ設定を開き、送信を有効化します。
3. 宛先 IP を `127.0.0.1`、ポートを `9000`、適当なレート（例: 60 Hz）に設定します。
4. タイムラインを再生すると、受信側に JSON が 1 行ずつ表示されます。
   例:
   ```text
   {'version': '0.6.0', 'session_id': 'demo-session', 'timestamp_ms': 1320, 'frame_index': 33, 'tracks': [{'name': 'camera.fov', 'value': 65.0}]}
   ```

## 制限事項とベストプラクティス
- UDP は非同期・非保証のため、パケットロスや順序入れ替わりが発生する可能性があります。重要な制御には補助の確認機構を併用してください。
- 1 パケットの目安サイズは数百バイトです。トラックが多い場合はネットワーク負荷を考慮し、必要に応じてレートやトラック数を調整してください。
- 送信先がファイアウォールで制限されているとパケットが破棄されるため、必要に応じて例外設定を行います。
- 遅延やスキップが目立つ場合は、送信レートを下げる・他プロセスの負荷を減らすなどで対応してください。
- テレメトリが受信できないときは、(1) `tools/udp_recv.py` でローカル受信を確認、(2) 宛先 IP/ポートとネットワーク疎通、(3) アプリ側で再生中かどうか、の順に切り分けると効率的です。
